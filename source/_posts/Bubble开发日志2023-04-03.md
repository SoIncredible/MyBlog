---
title: Bubbleå¼€å‘æ—¥å¿—2023_04_03
tags:
  - Unity
  - C#
  - Bubble
categories: å¼€å‘æ—¥å¿—
cover: 'http://soincredible777.com.cn:90/28.png'
abbrlink: c2115bb9
date: 2023-04-03 10:47:44
description:
swiper_index:
sticky:
---

æ–°çš„ä¸€å‘¨åˆå¼€å§‹äº†å–”ï¼Œä¸Šå‘¨æˆ‘ä»¬æ¢³ç†äº†ï¼Œåœ¨ä¸è€ƒè™‘æ•°æ®çš„æƒ…å†µä¸‹ï¼Œæ‰“å¼€ä¸€ä¸ªé¡µé¢çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­æ¢³ç†ï¼Œä¸€ä¸ªæ´»åŠ¨çš„æ•°æ®å®ƒä»å“ªé‡Œæ¥ï¼Œåˆåˆ°å“ªé‡Œå»ï¼Ÿåœ¨é¡µé¢æ‰“å¼€çš„è¿‡ç¨‹ä¸­å®ƒåˆæ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Ÿ

# è¿˜æ˜¯ä»¥ç‹¬è§’å…½æ´»åŠ¨ä¸ºä¾‹ï¼Œä»å¤´åˆ°å°¾çš„æ´»åŠ¨æ•°æ®å¦‚ä½•åˆ›å»ºå’Œè¢«ä¼ é€’

ä»Šå¤©å¥½å›°å•Šå•Šï¼Œæ˜¨å¤©æ™šä¸Šç¡ä¸ç€ï¼Œçˆ¬èµ·æ¥æ‰“æ¸¸æˆæ‰“åˆ°äº”ç‚¹å¤šï¼Œä¸Šåˆåˆ°äº†å…¬å¸æ•´ä¸ªäººéƒ½æ˜¯ç©ºçµçš„çŠ¶æ€ï¼Œä¸­åˆç¡äº†ä¸€è§‰åå¥½å¤šäº†ï¼Œä¸‹åˆè¦ç»§ç»­å¥½å¥½å·¥ä½œå¥½å¥½çœ‹ä»£ç å–”ğŸ˜¯

è¿›å…¥æ­£é¢˜ï¼Œæˆ‘ä»¬éœ€è¦çš„æ´»åŠ¨æ•°æ®éƒ½æ˜¯æ¥è‡ªä¸€å¼ å¼ Excelè¡¨ä¸­ï¼Œè¡¨ä¸­æœ‰æˆ‘ä»¬æ´»åŠ¨çš„ç¼–å·ã€æ´»åŠ¨çš„å¼€å¯å’Œç»“æŸæ—¶é—´ä»¥åŠæ´»åŠ¨çš„è½®æ¬¡ç­‰ç­‰ä¸€äº›ä¿¡æ¯ï¼Œä»æˆ‘ä»¬Unityå¼€å‘çš„èº«ä»½å‡ºå‘ï¼Œæˆ‘ä»¬å…¶å®æ˜¯ä¸å…³å¿ƒæˆ‘è¦å¦‚ä½•å–åˆ°è¿™äº›è¡¨é‡Œçš„æ•°æ®ï¼Œæˆ‘ä»¬æ›´åº”è¯¥å…³å¿ƒçš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°è·å–åˆ°æ´»åŠ¨çš„ä¿¡æ¯ï¼Œæˆ‘è¯¥æ€ä¹ˆå»ç”¨è·å–åˆ°çš„æ•°æ®å®Œæˆä¸šåŠ¡åŠŸèƒ½ã€‚

å½“ç„¶è¿™é‡Œè¿˜æ˜¯ç¨å¾®æä¸€ä¸‹æˆ‘ä»¬è·å–è¡¨ä¸­æ•°æ®çš„åŸç†ï¼šæœ‰ä¸€ä¸ªExcelè½¬æ¢å·¥å…·ï¼ˆç”¨Javaå†™çš„ï¼‰å°†æˆ‘ä»¬çš„è¡¨ç”Ÿæˆä¸ºä¸€ä¸ªbyteäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªåå«`Config`çš„è„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬é‡Œé¢å®šä¹‰äº†ä¸€ä¸ª`ConfnormalCDActivity`çš„ç±»ï¼Œç±»é‡Œé¢æœ‰ä¸€ä¸ªé™æ€çš„`Data`å­—å…¸ï¼Œæˆ‘ä»¬æ´»åŠ¨çš„æ•°æ®å°±å­˜æ”¾åœ¨è¿™ä¸ªå­—å…¸ä¸­ï¼Œæˆ‘ä»¬ä¸å¿…å…³å¿ƒè¡¨é‡Œçš„æ•°æ®æ˜¯å¦‚ä½•è¢«æ”¾åˆ°Dataå­—å…¸ä¸­å»çš„ï¼Œæˆ‘ä»¬åªè¦ä½¿ç”¨è¿™ä¸ªç±»ä¸­çš„`Get`æ–¹æ³•è·å–åˆ°Dataä¸­çš„æ•°æ®å°±å¯ä»¥äº†ã€‚

å¥½ï¼ç°åœ¨æˆ‘ä»¬ç¡®è®¤äº†æ•°æ®çš„æ¥æºï¼Œé‚£æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ´»åŠ¨æ•°æ®æ˜¯å¦‚ä½•åœ¨æ•´ä¸ªç¨‹åºä¸­æµé€šçš„å§ï¼è¿™ä¸ªè¿‡ç¨‹æå…¶åœ°å¤æ‚ï¼Œä¸æ˜¯æˆ‘ä¸€å¤©ä¸¤å¤©ä¹Ÿä¸æ˜¯ä¸€ç¯‡ä¸¤ç¯‡åšå®¢å°±èƒ½ææ¸…æ¥šçš„ä¸œè¥¿ï¼Œæˆ‘ç°åœ¨èƒ½åšçš„åªèƒ½æ˜¯ä»ä¸Šå±‚ä¸€ç‚¹ä¸€ç‚¹å¾€ä¸‹çœ‹åº•å±‚çš„å®ç°ï¼Œçœ‹åˆ°å“ªç®—å“ªå§ã€‚ğŸ˜‚

ä¸Šä¸€ç¯‡Bubbleå¼€å‘æ—¥å¿—ä¸­é€šè¿‡æµç¨‹å›¾çš„æ–¹å¼å‘ˆç°Pageæ‰“å¼€çš„è¿‡ç¨‹ï¼Œæˆ‘æ„Ÿè§‰æ•ˆæœå¾ˆå¥½ï¼Œæ‰€ä»¥æœ¬ç¯‡å¼€å‘æ—¥å¿—ä¸­ä¹Ÿä¼šä½¿ç”¨æµç¨‹å›¾æ¥æ¢³ç†æ•´ä¸ªè¿‡ç¨‹ï¼Œåªä¸è¿‡ä¸€å¼€å§‹å…ˆè¦å¬æˆ‘ç£•ç£•å·´å·´åœ°å£è¿°ä¸€éæ•´ä¸ªè¿‡ç¨‹ã€‚

åœ¨æ•´ä¸ªç¨‹åºè·‘èµ·æ¥ä¹‹å‰ï¼Œæˆ‘ä»¬å®šä¹‰çš„ä¸€äº›staticçš„æˆå‘˜å·²ç»è¢«åˆå§‹åŒ–äº†ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼š

ä¸€åˆ‡çš„èµ·ç‚¹éƒ½æ˜¯åœ¨`Launcher`è„šæœ¬ä¸­çš„`GameManager.Instance.SetUp()`ï¼Œè¿›å…¥SetUp()æ–¹æ³•ï¼Œæˆ‘ä»¬è¦çœ‹çš„ä»£ç å°±æ˜¯å›¾ä¸­æˆ‘æ‰“æ–­ç‚¹çš„å››è¡Œä»£ç ï¼š

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403160751687.png)

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403160807295.png)

`ActivityManager.Create()`

è¿™æ˜¯ç¨‹åºä¸€å¼€å§‹çš„æ—¶å€™åˆ›å»ºçš„ä¼—å¤šManagerçš„å…¶ä¸­ä¸€ä¸ªï¼Œ~~è¿™é‡Œå¹¶ä¸æ¶‰åŠæ•°æ®å±‚çš„ä¸œè¥¿~~~~ï¼Œåªæ˜¯å°†Managerä»¬éƒ½å®ä¾‹åŒ–ã€‚~~

~~æˆ³å•¦ï¼åœ¨è¿™é‡Œæ¶‰åŠåˆ°åˆå§‹åŒ–çš„é—®é¢˜ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹ä»£ç ï¼š~~

åˆæˆ³å•¦ï¼Œè¿™é‡Œåªæ˜¯æ³¨å†Œäº†ä¸€ä¸ªäº‹ä»¶å•Šï¼Œè€Œä¸æ˜¯å»è¿è¡ŒOnUpdateè¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥è¿˜æ˜¯ä¸ä¼šæ¶‰åŠåˆ°æ•°æ®çš„èµ‹å€¼çš„è¿‡ç¨‹ï¼Œä½†æ˜¯OnUpdateæ–¹æ³•é‡Œé¢çš„ä»£ç è¿˜æ˜¯è¦çœ‹çš„ï¼Œåé¢è¦ç•™æ„æ˜¯ä»€ä¹ˆæ—¶å€™ä¼šå‡ºå‘è¿™ä¸ªäº‹ä»¶

å…¶ä¸­Messager.Add(MessageCmd.OnUpdate,OnUpdate)æ˜¯åœ¨GameManagerè„šæœ¬çš„Updateä¸­è§¦å‘çš„äº‹ä»¶ï¼šæ¯æ¬¡æ‰§è¡ŒUpdateçš„æ—¶å€™å°±ä¼šå‘äº‹ä»¶ä¸­å¿ƒå‘é€OnUpdateçš„äº‹ä»¶ç„¶åè§¦å‘OnUpdateæ–¹æ³•ï¼Œä½†æ˜¯Updateæ–¹æ³•æ˜¯åœ¨SetUpæ–¹æ³•æ‰§è¡Œå®Œæˆåæ‰ä¼šæ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…³æ³¨çš„è¿™ä¸ªæµç¨‹ä¸­å¹¶ä¸ä¼šæ¶‰åŠOnUpdateä¸­çš„æ–¹æ³•ï¼Œè‡³å°‘ç›®å‰ä¸ä¼šã€‚

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230404143953794.png)

`ActivityManager`

![image-20230404144427497](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230404144427497.png)

`ActivityManager`è„šæœ¬çœ‹åˆ°è¿™å°±å¯ä»¥äº†ï¼Œåé¢çš„è„šæœ¬åœ¨ä¸€å¼€å§‹å¹¶ä¸ä¼šæ‰§è¡Œã€‚

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403184037804.png)

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403184104720.png)

`CheckWaitEnd`

```C#
 private void CheckWaitEnd()
        {
            if (ActivityDataManager.Instance.WaitEnd.Count <= 0)
            {
                return;
            }

            _endTimer -= Time.deltaTime;
            if (_endTimer > 0)
            {
                return;
            }

            var dataMgr = ActivityDataManager.Instance;
            var waitEnd = dataMgr.WaitEnd.Peek();
            if (_tempWaitEnd == null || waitEnd != _tempWaitEnd)
            {
                _tempWaitEnd = waitEnd;
                if (_tempWaitEnd.State == ActivityState.End)
                {
                    dataMgr.DequeueWaitEnd();
                    return;
                }
            }

            var mode = ActivityDefine.GetActivityMode(_tempWaitEnd.Type);
            var endTime = _tempWaitEnd.EndTime;
            if (endTime < DateTime.Now.TotalOfSeconds())
            {
                NextState(_tempWaitEnd);
                _tempWaitEnd = null;
            }
            else
            {
                var sec = endTime - DateTime.Now.TotalOfSeconds();
                if (sec > 3600f && _endTimerLevel < 5)
                {
                    _endTimer = 3600f;
                    _endTimerLevel = 5;
                }
                else if (sec > 1800f && _endTimerLevel < 4)
                {
                    _endTimer = 1800f;
                    _endTimerLevel = 4;
                }
                else if (sec > 600f && _endTimerLevel < 3)
                {
                    _endTimer = 600f;
                    _endTimerLevel = 3;
                }
                else if (sec > 60f && _endTimerLevel < 2)
                {
                    _endTimer = 60f;
                    _endTimerLevel = 2;
                }
                else if (sec > 10f && _endTimerLevel < 1)
                {
                    _endTimer = 10f;
                    _endTimerLevel = 1;
                }
                else
                {
                    _endTimer = 1f;
                    _endTimerLevel = 0;
                }
            }
        }
```

`NextState`

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403184345220.png)

`CheckWaitOpen`

```C#
  private void CheckWaitOpen()
        {
            if (ActivityDataManager.Instance.WaitOpen.Count <= 0)
            {
                return;
            }

            _startTimer -= Time.deltaTime;
            if (_startTimer > 0)
            {
                return;
            }

            var dataMgr = ActivityDataManager.Instance;
            var open = dataMgr.WaitOpen.Peek();
            if (_tempWaitOpen == null || open != _tempWaitOpen)
            {
                _tempWaitOpen = open;
                if (_tempWaitOpen.State == ActivityState.End)
                {
                    dataMgr.DequeueWaitOpen();
                    return;
                }
            }

            var mode = ActivityDefine.GetActivityMode(_tempWaitOpen.Type);
            var startTime = _tempWaitOpen.StartTime;
            if (startTime < DateTime.Now.TotalOfSeconds())
            {
                OpenActivity(_tempWaitOpen);
                _tempWaitOpen = null;
            }
            else
            {
                var sec = startTime - DateTime.Now.TotalOfSeconds();
                if (sec > 3600f && _startTimerLevel < 5)
                {
                    _startTimer = 3600f;
                    _startTimerLevel = 5;
                }
                else if (sec > 1800f && _startTimerLevel < 4)
                {
                    _startTimer = 1800f;
                    _startTimerLevel = 4;
                }
                else if (sec > 600f && _startTimerLevel < 3)
                {
                    _startTimer = 600f;
                    _startTimerLevel = 3;
                }
                else if (sec > 60f && _startTimerLevel < 2)
                {
                    _startTimer = 60f;
                    _startTimerLevel = 2;
                }
                else if (sec > 10f && _startTimerLevel < 1)
                {
                    _startTimer = 10f;
                    _startTimerLevel = 1;
                }
                else
                {
                    _startTimer = 1f;
                    _startTimerLevel = 0;
                }
            }
        }
```

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403184230002.png)

`OpenActivity()`

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403184317818.png)

ç›®å‰æš‚ä¸æ˜¯å¾ˆæ¸…æ¥šä¸Šé¢è¿™ä¸ªæ–¹æ³•æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œä½†æ˜¯åœ¨å®ƒä»¬çš„æ–¹æ³•ä¸­éƒ½è°ƒç”¨äº†`OpenActivity`çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­åˆç”¨åˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„å¤šæ€ï¼Œ`mode`å˜é‡æ˜¯ä¸€ä¸ªBaseç±»å‹çš„ï¼Œä½†æ˜¯æ ¹æ®`GetActivityMode`è¿”å›çš„ç±»å‹ä¸åŒï¼Œå®ç°ä¸åŒçš„å¤šæ€ï¼Œç„¶åæ˜¯`mode.ActivityStartCallBack`æ–¹æ³•ï¼š

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403185038995.png)

è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®`mode`çš„ç±»å‹ä¸åŒæ‰§è¡Œä¸åŒçš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä»¥ç‹¬è§’å…½ä¸ºä¾‹ï¼š

```C#
        public override void EnterActivity(OneActivityData data)
        {
            D.Info($"[RaceActivity]: ç«é€Ÿæ´»åŠ¨å¼€å¯ï¼Œ {data.Id}, {data.TableId}");
            var act = ActivityDataManager.Instance;
            if (act.GetSimpleActivity(data.Type) == null)
            {
                var skin = 0;
                foreach (var pair in ConfRaceSkin.Data.Values)
                {
                    var startTime = DateTime.Parse(pair.StartTime).TotalOfSeconds();
                    var endTime = DateTime.Parse(pair.EndTime).TotalOfSeconds();
                    if (data.StartTime >= startTime && data.StartTime <= endTime)
                    {
                        skin = pair.Skin;
                        break;
                    }
                }

                act.SetSimpleActivity(data.Type, data);
                var total = AnalyzeDataManager.Instance.TotalCount - AnalyzeDataManager.Instance.PlayCountDay;
                UnicornRaceDataManager.Instance.ResetOnStart(total,
                    StoreRoot.Inst.Common.LiveDays - 1);
                UnicornRaceDataManager.Instance.SetRaceSkin(skin);
                UnicornRaceDataManager.Instance.OpenActivity();
                UnicornRaceDataManager.Instance.SetState(RaceState.WaitOpen);
            }
            else
            {
                UnicornRaceDataManager.Instance.OpenActivity();
                if (UnicornRaceDataManager.Instance.State == RaceState.End)
                {
                    var total = AnalyzeDataManager.Instance.TotalCount - AnalyzeDataManager.Instance.PlayCountDay;
                    UnicornRaceDataManager.Instance.TurnOpen(total,
                        StoreRoot.Inst.Common.LiveDays - 1);
                }
            }

            if (data.State == ActivityState.Opening && !UnicornRaceDataManager.Instance.HasOperateRaceEnterDlg)
            {
                GuideManager.Instance.CheckRaceActivity(data);
            }

            Messager.Dispatch(MessageCmd.ActivityStart, data.Type);
        }
```



åˆ°è¿™ï¼Œ

`DataManager.Create()`

å„ç§çš„æ•°æ®ç®¡ç†å™¨éƒ½ä¼šåœ¨è¿™é‡Œåˆ›å»ºï¼ŒåŒ…æ‹¬æˆ‘ä»¬çš„ActivityDataManagerï¼š

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403162323018.png)

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403162446831.png)

è¿™é‡Œæˆ‘ä»¬å®ä¾‹åŒ–äº†ActivityDataManagerï¼Œä¸€ä¸ªå®ä¾‹ActivityDataManagerä¸­å«æœ‰çš„æˆå‘˜å¦‚ä¸‹ï¼š

ç„¶åæˆ‘ä»¬æ¥ç€çœ‹ä¸€ä¸‹`Init`æ–¹æ³•ï¼š

```C#
var temp = new Dictionary<int, List<TempActivityData>>(8);
foreach (var pair in ConfNormalCDActivity.Data)
{
    if (!temp.ContainsKey(pair.Value.Type))
    {
        temp.Add(pair.Value.Type, new List<TempActivityData>(32));
    }

    if (!DateTime.TryParse(pair.Value.StartTime, out var time))
    {
        continue;
    }

    temp[pair.Value.Type].Add(new TempActivityData()
    {
        Id = pair.Value.ID,
        startTime = time.TotalOfSeconds(),
    });
}

ActivityCheck = new Dictionary<int, List<int>>(temp.Count);
foreach (var pair in temp)
{
    pair.Value.Sort((x, y) => x.startTime.CompareTo(y.startTime));
    ActivityCheck.Add(pair.Key, new List<int>(pair.Value.Count));
    foreach (var data in pair.Value)
    {
        ActivityCheck[pair.Key].Add(data.Id);
    }
}

WaitOpen = new Queue<OneActivityData>(2);
WaitEnd = new Queue<OneActivityData>(1);
Waiting = new List<bool>((int) ActivityType.Length);
for (var i = ActivityType.FeedPet; i < ActivityType.Length; i++)
{
    Waiting.Add(false);
}

AllActivityData = new Dictionary<ActivityType, Dictionary<int, OneActivityData>>(1);

if (SimpleActivityData == null)
{
    SimpleActivityData = new Dictionary<ActivityType, OneActivityData>(2);
}

if (SimpleActivityUnlockState == null)
{
    SimpleActivityUnlockState = new Dictionary<ActivityType, UnlockState>(2);
}

if (ActivityLastDay == null)
{
    ActivityLastDay = new Dictionary<ActivityType, int>(2);
}

foreach (var pair in SimpleActivityData)
{
    AddListener(pair.Value);
}
```

æˆ‘ä»¬å·²ç»éœ€è¦ä½¿ç”¨`ConfNormalCDActivity.Data`ä¸­çš„æ•°æ®äº†ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„tempå­—å…¸æ¥å­˜å‚¨ä¸€ä¸ªKeyå€¼ä¸ºintç±»å‹ï¼Œvalueä¸ºTempActivityDataç±»å‹çš„å­—å…¸ï¼ŒTemp Activityæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œé‡Œé¢åŒ…å«æœ‰`id`å’Œ`startTime`ä¸¤ä¸ªå±æ€§ã€‚

æˆ‘å…ˆéå†æ•´ä¸ªDataï¼Œç¡®ä¿å°†æ‰€æœ‰æ´»åŠ¨çš„Keyéƒ½æ·»åŠ åˆ°è¿™ä¸ªä¸´æ—¶çš„tempå­—å…¸ä¸­å»ã€‚é‚£ä¹ˆtempå°±æˆä¸ºäº†ä¸€ä¸ªå­˜æœ‰æ´»åŠ¨çš„typeä½Keyå€¼æ¯ä¸€ä¸ªKeyå€¼å¯¹åº”ç€çš„æ˜¯ä¸€ä¸ªtypeçš„æ´»åŠ¨åˆ—è¡¨ï¼Œå› ä¸ºæ´»åŠ¨æ˜¯å‘¨æœŸå¼€å¯çš„å˜›ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚é‚£ä¹ˆæœ€åæ•´ä¸ªtempå­—å…¸çš„ç»“æ„å°±æ˜¯ä¸‹é¢è¿™æ ·ï¼š

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/TempActivityDataå­—å…¸æ•°æ®ç»“æ„å›¾.png)

ç´§æ¥ç€æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª`ActivityCheck`çš„å­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„Keyå€¼æ˜¯intç±»å‹ï¼ŒValueæ˜¯ä¸€ä¸ªintç±»å‹çš„Listï¼›

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403170538636.png)

è¿™æ®µä»£ç æ˜¯ä¸ºäº†ç¡®ä¿æ¯ä¸€ä¸ªKeyå€¼å¯¹åº”çš„Listæ˜¯æŒ‰ç…§æ—¶é—´çš„å…ˆåé¡ºåºæ’åˆ—çš„ï¼Œæ’å¥½åºä¹‹åï¼Œå°†Listçš„idåŠ å…¥åˆ°`ActivityCheck`å­—å…¸ä¸­ï¼Œè¿™ä¸ªå­—å…¸çš„ä½œç”¨æ˜¯ä¸ºäº†æ›´æ–¹ä¾¿åœ°è·å–æ¯ä¸€ä¸ªæ´»åŠ¨å®ƒä»¬çš„idçš„listã€‚

ä¸‹é¢åˆå§‹åŒ–äº†ä¸‰ä¸ªé˜Ÿåˆ—ï¼š

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230403171029259.png)

 è¿™ä¸‰ä¸ªé˜Ÿåˆ—ä»£è¡¨äº†æ´»åŠ¨çš„ä¸‰ç§çŠ¶æ€ï¼Œè¿™ä¸ªç¨åä¼šæï¼Œé‚£ä¹ˆåˆ°è¿™`DataManager`çš„ä»£ç ä¹Ÿèµ°å®Œäº†ã€‚

`ActivityManager.Instance.StartafterAllInit()`

```C#
public void StartAfterAllInit()
        {
            foreach (var act in ActivityDefine.Activities)
            {
                act.AddListener();
            }

            AfterListener();

            foreach (var data in ActivityDataManager.Instance.WaitEnd)
            {
                ActivityDefine.Activities[(int) data.Type].EnterActivity(data);
            }

            var list = new List<OneActivityData>(2);
            for (int i = 0; i < ActivityDefine.Activities.Count; i++)
            {
                var act = ActivityDefine.Activities[i];
                var data = act.FindWait();
                if (data != null)
                {
                    list.Add(data);
                }
            }

            list.Sort(delegate(OneActivityData data, OneActivityData activityData)
            {
                var start1 = data.StartTime;
                var start2 = activityData.StartTime;
                return start1.CompareTo(start2);
            });

            for (int i = 0; i < list.Count; i++)
            {
                EnqueueWaitOpen(list[i], false);
                ActivityDataManager.Instance.SetWaiting(list[i].Type, true);
            }

            _hasInit = true;
        }

```

è¿™æ®µä»£ç ä»¥ä¸Šæ¥å°±ç”¨åˆ°äº†æˆ‘ä»¬é™æ€ç”Ÿæˆçš„Activityåˆ—è¡¨ï¼Œç„¶åç»™æ¯ä¸ªæ´»åŠ¨çš„å®ä¾‹æ·»åŠ ä¸Šlistenerï¼Œå¯¹äºç‹¬è§’å…½æ´»åŠ¨æ¥è¯´è¿™ä¸€æ­¥æ²¡æœ‰å½±å“ï¼Œç„¶åæ˜¯`AfterListener`æ–¹æ³•

```C#
   public void AfterListener()
        {
            var list = new List<OneActivityData>(2);
            var listStart = new List<OneActivityData>(1);
            var listEnd = new List<OneActivityData>(1);
            var now = DateTime.Now.TotalOfSeconds();
            foreach (var pair in ActivityDataManager.Instance.AllActivityData)
            {
                foreach (var p in pair.Value)
                {
                    var mode = ActivityDefine.GetActivityMode(p.Value.Type);
                    if (mode != null && !mode.CanOpen())
                    {
                        listEnd.Add(p.Value);
                        continue;
                    }

                    if (p.Value.State == ActivityState.Opening)
                    {
                        list.Add(p.Value);
                    }
                    else if (p.Value.State == ActivityState.WaitGuideStart)
                    {
                        listStart.Add(p.Value);
                    }
                    else if (p.Value.State == ActivityState.WaitGuideEnd)
                    {
                        listEnd.Add(p.Value);
                    }
                }
            }

            list.Sort(delegate(OneActivityData data, OneActivityData activityData)
            {
                var end1 = data.EndTime;
                var end2 = activityData.EndTime;
                return end1.CompareTo(end2);
            });

            for (int i = 0; i < list.Count; i++)
            {
                EnqueueWaitEnd(list[i], false);
            }

            foreach (var data in listStart)
            {
                if (data.EndTime <= now || data.StartTime > now || !IsDataValid(data))
                {
                    ActivityDataManager.Instance.DeleteActivity(data.Type);
                    ActivityDataManager.Instance.RemoveSimpleActivity(data.Type);
                    continue;
                }

                var mode = ActivityDefine.GetActivityMode(data.Type);
                mode.EnterActivity(data);
                mode.CheckStartGuide(data);
            }

            foreach (var data in listEnd)
            {
                var mode = ActivityDefine.GetActivityMode(data.Type);
                if (mode.CanOpen())
                {
                    mode.CheckEndGuide(data, true);
                }
                else
                {
                    data.State = ActivityState.WaitGuideEnd;
                    NextState(data);
                }
            }
        }

```

è¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯åœ¨æ·»åŠ å®ŒListenerä¹‹åï¼Œ

`ActivityManager.Instance.ReCheckWaitEnd()`

# 2023.04.17æ›´æ–°

å¥½ä¹…æ²¡æ›´æ–°åšå®¢äº†å–”ï¼Œè¿™æ®µæ—¶é—´è¿‡åˆ†å·æ‡’äº†ï¼Œå› ä¸ºè¿™æ®µæ—¶é—´Bubbleçš„æ•°æ®å¹¶ä¸ä¹è§‚ï¼Œå¤§å®¶æƒ³è¦é€šè¿‡å›é€€ç‰ˆæœ¬çš„æ–¹å¼å¯»æ‰¾åŸå› ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰ä»€ä¹ˆäº‹åšï¼Œæ¯å¤©åœ¨å·¥ä½ä¸Šç‹ ç‹ çš„æ‘¸é±¼è€æ‰‹æœºï¼Œä½†æ˜¯è¿™å‘¨é‡æ–°æŒ¯ä½œèµ·æ¥å–”ï¼ğŸ˜¯

è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨æ¢³ç†ç‹¬è§’å…½çš„ä¸œè¥¿ï¼ˆæ¢³ç†åŠæœˆæœ‰ä½™äº†ã€‚ã€‚ã€‚ã€‚ï¼‰ä¸€ç›´åœæ»ä¸å‰ï¼Œå› ä¸ºå›°éš¾é‡é‡å•Šï¼Œç»å¸¸ä¼šé™·å…¥è¿™è¡Œä»£ç ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ï¼Ÿè¿™ä¸ªå‡½æ•°åœ¨å“ªé‡Œè°ƒç”¨ï¼Ÿç­‰ç­‰é—®é¢˜ï¼Œç„¶åå½“æˆ‘ææ˜ç™½è¿™ä¸ªé—®é¢˜ä¹‹åå†å›è¿‡å¤´æ¥æ¢³ç†ç‹¬è§’å…½çš„æ—¶å€™ï¼Œå·²ç»å¿˜è®°æ¢³ç†åˆ°å“ªä¸€ä¸ªç¯èŠ‚äº†ğŸ˜‚

æ‰€ä»¥æˆ‘ä»¬å°±ç›´æ¥æŠ›å¼ƒä»£ç å§ï¼æˆ‘ä»¬ç°åœ¨çš„èº«ä»½æ˜¯ä¸€ä¸ªäº§å“çš„åŒå­¦ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç­–åˆ’çš„åŒå­¦ï¼Œæˆ‘ä»¬ç°åœ¨è¦è®¾è®¡ç‹¬è§’å…½è¿™æ ·ä¸€ä¸ªæ´»åŠ¨ï¼Œæˆ‘éœ€è¦å…ˆåœ¨é€»è¾‘å’Œæµç¨‹ä¸Šæ˜ç¡®ç‹¬è§’å…½çš„è¿‡ç¨‹ï¼Œç„¶åå°†æµç¨‹åŒæ­¥ç»™å¼€å‘çš„åŒå­¦ã€‚

çœ‹è¡¨æ ¼ï¼š

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230417121817415.png)

è¿™ä¸ªè¡¨æ ¼é‡Œé¢å°±åŒ…æ‹¬äº†ç‹¬è§’å…½æ´»åŠ¨çš„æ‰€æœ‰çŠ¶æ€äº†ï¼Œä»¥åŠæ¯ç§çŠ¶æ€å¦‚ä½•è½¬å˜çš„ç­‰ç­‰ã€‚

åœ¨è¿™é‡Œæ”¾ä¸€ä¸ªGoogleäº‘ç›˜çš„[é“¾æ¥](https://docs.google.com/spreadsheets/d/1BFLnkiqFejvttM5vonINf3BgpBuXItb1/edit#gid=2028417854)

ä¸‹é¢è¿™ä¸ªæµç¨‹å›¾æ›´ç›´è§‚çš„å±•ç¤ºäº†å„ç§çŠ¶æ€ä¹‹é—´æ˜¯å¦‚ä½•è½¬å˜çš„ä»¥åŠçŠ¶æ€è½¬å˜çš„è§¦å‘æ¡ä»¶æ˜¯ä»€ä¹ˆã€‚

![](Bubbleå¼€å‘æ—¥å¿—2023-04-03/image-20230417122015771.png)

å…³äºç‹¬è§’å…½æ´»åŠ¨çš„æ¢³ç†å°±å…ˆå‘Šä¸€æ®µè½å§ğŸ¥²è¡¥å……çŸ¥è¯†ï¼Œä¸æ–­è¿›æ­¥

æˆ‘ä»¬é¡¹ç›®çš„Launcherè„šæœ¬æ˜¯ä¸€åˆ‡å¼€å§‹çš„åœ°æ–¹ï¼Œå®ƒé‡Œé¢çš„Startæ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯IEnumeratorç±»å‹çš„ï¼Œæˆ‘å…¶å®ç°åœ¨æ˜¯Getä¸åˆ°ä¸ºä»€ä¹ˆè¦è¿™æ ·å†™ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·å†™çš„ï¼Œå°±å…ˆåœ¨è¿™é‡ŒæŒ–ä¸€ä¸ªå‘å§ã€‚

https://answers.unity.com/questions/754968/can-monobehaviorstart-return-an-ienumerator-hint-y.html









