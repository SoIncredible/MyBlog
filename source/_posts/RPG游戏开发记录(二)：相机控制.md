---
title: RPG游戏开发记录(二)：相机控制
tags:
  - RPG
categories: RPG游戏开发
cover: https://www.notion.so/images/page-cover/met_vincent_van_gogh_ginoux.jpg
abbrlink: ea538f2a
date: 2024-09-15 00:38:54
description:
swiper_index:
sticky:
---

# 基本思想

我们先来拆分一下相机的运动——相机跟随、水平转向、垂直转向
我们会把相机的节点设置为三层，最外层负责跟随角色移动、中间层负责相机水平方向上的转向、最内层负责相机竖直方向的转向。

通过体验巫师三和GTAV的游戏，你会发现相机的水平和竖直转动都是以控制的角色为轴旋转的。


# 了解用到的接口
- transform.InverseTransformDirection
  传入一个世界空间坐标下表示的三维向量，得到这个transform对象空间坐标下该向量的表示
- transform.TransformDirection
  传入一个在该transform坐标空间下表示的三维向量，得到这个向量在世界空间坐标下的表示
- transform.RotateAround
  使一个物体绕着某一点的某一个方向旋转
- Vector3.SmoothDamp

摄像机会分成三层结构，最外层控制跟随角色，中间层控制绕角色旋转，最内层控制俯仰旋转。

相机跟随分为两部分


- 相机跟随物体部分
- 鼠标可以控制相机移动
  - 控制相机又可以分为水平和垂直方向
所以我们的摄像机是一个三层嵌套结构最外层控制位置，第二层控制旋转，第三层也就是相机组件本层控制俯仰
为了和Player部分统一，我们都适用Quaternion接口设置相机的旋转信息
我们要设置相机围绕着Player旋转。

这里需要注意的是镜头向右看的时候实际上是顺时针旋转
镜头向左看的时候是逆时针旋转

相机的水平旋转始终是在一个xz平面中进行的。我们在每一帧中使用sin、cos的计算得到距离物体位置的偏移位置，这就是相机当前位置

我还需要知道相机距离角色的距离，这个距离应该是三维空间下的距离，比如说如果摄像机的视角很高的话，这时候镜头就会离控制角色的头顶很近，我们需要有一套逻辑去动态控制这个距离，比如说角色靠墙很近的时候，镜头要尽可能地靠近角色，这个功能能不能直接通过给相机上装一个碰撞体实现？

另外还需要注意的是，相机的旋转是以我们控制的角色为中心的，在视角中我们的角色一般偏左，镜头旋转也是围绕着左侧为轴进行的

我们需要用到矩阵转换的知识


# 外层跟随逻辑
# 中层旋转逻辑

中层我们就让

# 内层俯仰逻辑

内层俯仰的实现还算简单，但是我们需要给视角的旋转设定一下上下限制
这里会有个坑，就是 我们在Inspector窗口中看到的rotation是负值，但是在代码中，通过transform.localRotation获得的值都是[0 ~ 360]之间的，因此需要把负值转变为360 + 负值

# 摄像机碰撞

通过观察GTA


# 实现相机跟随中的数学知识

如果不使用Unity Transform提供的接口，该如何实现向量从世界空间和对象空间向量的变换呢？

在数学上实现坐标空间的变换需要的是矩阵变换，

本来笔者认为相机的俯仰只是简单的旋转相机组件自己节点的x轴就可以实现，但是在对比了巫师三和GTAV的视角模式，发现也是绕着角色的轴旋转的。