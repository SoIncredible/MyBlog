---
title: 3D数学基础——矩阵
categories: 3D数学基础
abbrlink: 28fc275d
date: 2025-02-15 12:18:54
tags:
cover: https://public.ysjf.com/mediastorm/material/material/%E8%B4%B9%E5%B0%94%E7%8F%AD%E5%85%8B%E6%96%AF-12-%E5%85%A8%E6%99%AF-20250107.JPG
description:
swiper_index:
sticky:
---

渲染管线中的矩阵变换:

局部坐标(Local Space) 
    ↓ 模型矩阵(Model Matrix)
世界坐标(World Space)
    ↓ 观察矩阵(View Matrix) 
观察坐标(View Space)
    ↓ 投影矩阵(Projection Matrix)
裁剪坐标(Clip Space)
    ↓ 透视除法(Perspective Division)
标准化设备坐标(NDC Space) ← 你的顶点数据在这里
    ↓ 视口变换(Viewport Transform)
屏幕坐标(Screen Space)

# 对于矩阵要先平移至原点 再进行旋转 然后平移回原位置的数学解释
```c++
// 1. 先将矩形平移到原点（使其中心在原点）
// 2. 旋转
// 3. 再平移到目标位置

glm::mat4 transform = glm::mat4(1.0f);
transform = glm::translate(transform, glm::vec3(0.5f, -0.5f, 0.0f)); // 最终位置
transform = glm::rotate(transform, (float)glfwGetTime(), glm::vec3(0.0f, 0.0f, 1.0f)); // 旋转
transform = glm::translate(transform, glm::vec3(-0.5f, 0.5f, 0.0f)); // 先将中心移到原点（反向平移）
```



# 矩阵平移的推导过程

# 主动变换与被动变换



## 主动变换

重点在如何用矩阵表示旋转、缩放、平移等操作.

### 旋转

#### 在二维中的旋转

#### 围绕主轴的三维旋转的矩阵推导

使用高斯消元法求解线性方程组, 使用矩阵表示旋转, 在三维空间的左手坐标系中, 以绕着y轴顺时针旋转$\theta$度, 注意左手系中, 顺时针旋转为正向旋转. 来构建方程组
设点$P_1(x_1, y, z_1)$, 经过上述所说的旋转矩阵M, 旋转到$P_2(x_2, y, z_2)$, $P_1$、$P_2$已知, 求旋转矩阵M.

构建方程组
已知向量$\vec{OP_1}$、$\vec{OP_2}$
根据向量内积(点积)
$$ \vec{OP_1} \cdot \vec{OP_2} = |\vec{OP_1}||\vec{OP_2}|cos\theta $$
根据向量外积(叉积)
$$ \begin{bmatrix}
  x_1\\
  y \\
  z_1
\end{bmatrix}^T
\times 
\begin{bmatrix}
  x_2\\
  y \\
  z_2
\end{bmatrix}^T
= \begin{bmatrix}
  yz_2 - z_1y\\
  z_1x_2 - x_1z_2\\
  x_1y - yx_2
\end{bmatrix}^T
$$

另有
$$ | \vec{OP_1} \times \vec{OP_2}| = | \vec{OP_1} | \cdot | \vec{OP_2} | sin\theta$$

为了方便计算, 我们让y等于零, 则$P_1$、$P_2$点均落在了XZ平面上, 代入得到下面方程组

$$
\left\{\begin{matrix} x_1x_2 + z_1z_2 = (x_1^2 + z_1^2)cos\theta 
 \\
(z_1x_2 - x_1z_2)^2 = (x_1^2 + z_1^2)^2sin^2\theta 
\end{matrix}\right.
$$

令$x_1^2 + z_1^2 = A$, 令$sin\theta = S$, $cos\theta = C$, 代入消元

$$
\left\{\begin{matrix} z_1x_2- x_1z_2 = \pm AS
 \\
x_1x_2 + z_1z_2 = \pm AC
\end{matrix}\right.
$$

上述方程组共有四组解, 分别是

都为正, 左手系中代表顺时针旋转的. 正向旋转

$$
\left\{\begin{matrix} x_2= z_1sin\theta + x_1cos\theta 
 \\
z_2 = z_1cos\theta  - x_1sin\theta
\end{matrix}\right.
$$

都为负, 左手系中代表逆时针旋转的. 负向旋转

$$
\left\{\begin{matrix} x_2 = -x_1cos\theta - z_1sin\theta
 \\
z_2 = x_1sin\theta - z_1cos\theta
\end{matrix}\right.
$$

因此根据矩阵的运算规则构建出旋转矩阵

一正一负
$$
\left\{\begin{matrix} x_2 = x_1cos\theta - z_1sin\theta
 \\
z_2 = z_1cos\theta + x_1sin\theta
\end{matrix}\right.
$$

$$
\left\{\begin{matrix} x_2 = x_1cos(-\theta) + z_1sin(-\theta)
 \\
z_2 = z_1cos(-\theta) - x_1sin(-\theta)
\end{matrix}\right.
$$


一正一负的另一组解

$$
\left\{\begin{matrix} x_2 = -x_1cos\theta + z_1sin\theta
 \\
z_2 = -x_1sin\theta - z_1cos\theta
\end{matrix}\right.
$$

这一组解其实等价于都为正的情况, 可以变换为, 意思是逆时针转了$-\theta$度, 其实就是顺时针转了$\theta$度, 所以 等价于都为正的情况
$$
\left\{\begin{matrix} x_2 = -x_1cos(-\theta) - z_1sin(-\theta)
 \\
z_2 = x_1sin(-\theta) - z_1cos(-\theta)
\end{matrix}\right.
$$

一正一负的两种情况可以转化成都为正和都为负的情况.
根据矩阵的运算规则可以写出上述四组解的矩阵:
因此我们就知道了表示正向旋转、逆向旋转的写法了.

#### 围绕任意轴的三维旋转

### 平移

## 被动变换

坐标系的变换, 重点是渲染流水线中各坐标系变换矩阵的推导

### Model Matrix

### View Matrix

已知y轴与
构造View Matrix需要知道摄像机的三个属性: 摄像机朝向、摄像机的右侧, 以及摄像机的位置

[](https://learnopengl.com/img/getting-started/camera_axes.png)

有一个临界情况 如果摄像机的位置在y轴上, 也就是相机朝向的向量与y轴平行时, 上述构造摄像机右侧向量的方法就有问题了, 看一下Unity中是怎么处理这个问题的吧.
### Projection Matrix

### Clip Matrix

### Homogenous divide

### Map to window